
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	<body>
		<h1>Test...</h1>

		<div style='border:1px solid black;width:50%'>
			<span id='e1' class='goofyTextEditable'>Lorem ipsum aliqua proident veniam et quis consectetur esse dolore non Ut nulla dolor eu culpa. Lorem ipsum sint cupidatat non et adipisicing esse elit officia. 
			proident, sunt in culpa qui officia deserunt mollit anim id est laborum. </span><span style='background-color:blue'>I Am some sort of inline object representation--not text editable. k?</span> <span id='e2' class='goofyTextEditable' style='display:inline;'> Aaaaa bbbbbb ccccc dddddd eeeeee jjjjjj kkkkkk labore et dolore magna alnt o anim id est laborum. </span>
		</div> 
	</body>

	<script type="text/javascript" src="../../ext_3_2_1/adapter/ext/ext-base-debug.js"></script>
	<script type="text/javascript" src="../../ext_3_2_1/ext-all-debug.js"></script>

	<script type='text/javascript'>

		goofyText = {

			cursorHistory: []
			, cursorNextColor: 'black'
			, cursorblackCycles: 0
			, cursorTimeoutId: null
			, suppressClearChar: false
			, suppressNextKeypress: false
			, targetChar: false


			, clearFlipHistory: function(){

				for (var i=0;i<goofyText.cursorHistory.length; ++i){

					if (goofyText.cursorHistory[i] === goofyText.targetChar) continue;

					goofyText.cursorHistory[i].setStyle('border-left', 'inherit');
					goofyText.cursorHistory[i].setStyle('margin-left', 'inherit');
				}
			}

			, cursorFlip: function(){
				
				goofyText.clearFlipHistory();

				if (goofyText.targetChar && goofyText.targetChar.setStyle){
					
					if (goofyText.cursorblackCycles){
						goofyText.cursorNextColor = 'black';
						goofyText.cursorblackCycles--;
					}

					goofyText.targetChar.setStyle('border-left', '2px solid '+goofyText.cursorNextColor);
					goofyText.targetChar.setStyle('margin-left', '-2px');

					goofyText.cursorNextColor= goofyText.cursorNextColor==='white'?'black':'white';
					clearTimeout(goofyText.cursorTimeoutId);
					goofyText.cursorTimeoutId = setTimeout( goofyText.cursorFlip, 1000 )
				} else {
					goofyText.cursorNextColor = 'black';
				}
				

			}


			, init: function(){
					Ext.getDoc().on('click', function(){
						setTimeout( goofyText.clearFlipHistory, 50) // Less delay for "blurring" the field.
						if (!goofyText.suppressClearChar){
							goofyText.targetChar = null;
							
						}else{
							goofyText.suppressClearChar = false;
						}
					});				

					goofyText.cursorFlip();

					document.onkeypress = function(evt){
						if (!goofyText.targetChar) return;
						if (goofyText.suppressNextKeypress) return;

						// Figure out other reasons to get out of this place.

						var evt = evt || window.event
						var chr = String.fromCharCode(evt.keyCode || evt.which)
						var newChrNode;

						if (evt.keyCode===13){ chr = '\n' }

						if (chr){
							newChrNode = goofyText.mkChar(chr);
							goofyText.targetChar.dom.parentNode.insertBefore(newChrNode, goofyText.targetChar.dom);
							goofyText.setClick(newChrNode);
							goofyText.targetChar.dom.click();
						}

					}

					document.onkeydown = function(evt){
						if (!goofyText.targetChar) return;

						var evt = evt || window.event
						var chr = String.fromCharCode(evt.keyCode)

						switch (evt.keyCode){
							case 8: // backspace
								var search = goofyText.targetChar.dom.previousSibling;
								
								if (search && search.className === 'chr'){
									goofyText.targetChar.dom.parentNode.removeChild(search)
								}
								
								// Stupid thing to stop the browser from going back.
								evt.keyCode = 0;

								goofyText.suppressNextKeypress=true;
								break;

							case 9: // tab
								goofyText.targetChar = null;

								goofyText.suppressNextKeypress=true;
								break;

							case 37: // left

								console.log ("Going left")
								var search = goofyText.targetChar.dom;
								while (search !== null){
									search = search.previousSibling;
									if (search && search.className === 'chr'){
										search.click();
										break;
									}
								}

								evt.preventDefault()

								goofyText.suppressNextKeypress=true;
								break;

							case 39: // right

								console.log ("Going right")
								var search = goofyText.targetChar.dom;
								while (search !== null){
									search = search.nextSibling;
									if (search && search.className === 'chr'){
										search.click();
										break;
									}
								}

								goofyText.suppressNextKeypress=true;
								break;

							default:
								goofyText.suppressNextKeypress=false;


						}

					}
			}

			, searchAndSetup: function(){
				Ext.each(Ext.query('.goofyTextEditable'), function(){
					goofyText.setup(Ext.get(this));
				});
			}

			, setup: function(node){
				if (node.goofyTextSetup) return false;
				node.goofyTextSetup = true;

				var placeHolder	= document.createElement('div');
				var throwAway 	= document.createElement('div');
				var chr 		= null;

				
				// Find textNodes and explode them into goofyText chrs.
				// Other nodes will just be reused verbatim.
				// All of these things will be pushed onto the placeHolder element.
				while (node.dom.childNodes.length){
					var cNode = node.dom.childNodes[0];

					if (!cNode) return false;
					
					if (cNode.nodeType===3){
						// It's a text node, break it up int chrs
						for (var i=0; i<cNode.length; ++i){

							if (cNode.textContent){
								chr = goofyText.mkChar(cNode.textContent[i]);

							} else if (cNode.nodeValue){
								chr = goofyText.mkChar(cNode.nodeValue[i]);

							} else {
								throw "What am I supposed to do?"
							}

							placeHolder.appendChild(chr);
						}
						throwAway.appendChild(cNode);
					}
					else {
						placeHolder.appendChild(cNode);
					}
				}

				// Move all the children filed into placeHolder back into the
				// original element.
				while (placeHolder.childNodes.length){
					node.dom.appendChild(placeHolder.childNodes[0]);
				}


				// Add clicks to each char
				Ext.each(node.query('span.chr'), function(){
				 	goofyText.setClick(this);
				});

			}

			, setClick: function(node){
				Ext.get(node).on('click', function(){
				  	goofyText.targetChar = this;
				  	goofyText.cursorHistory.push(this);
				  	goofyText.suppressClearChar = true;
				  	goofyText.cursorNextColor = 'black';
				  	goofyText.cursorFlip();
			 	});				
			}

			, mkChar: function(character){
				var chr = document.createElement('span')
				chr.className = 'chr'

				if ( character ==='\n' ) {
					chr.innerHTML = "<br />"

				} else {
					if (chr.textContent!==undefined){
						chr.textContent = character;
					} else {
						chr.innerText = character;
					}
					
				}

				return chr


			}


		}

		goofyText.init();
		goofyText.searchAndSetup();



	</script>

</html>